echo "Creating consensus from reference and alignment file"
echo "Converting sam to bam...."
samtools view -bF 4 $2 >mapped.bam 2>null
echo "Adding groups names..."
~/Software/jre1.8.0_191/bin/java -jar -XX:ParallelGCThreads=16  ~/Software/picard.jar AddOrReplaceReadGroups I=mapped.bam O=rg_added_sorted.bam SO=coordinate RGID=id RGLB=library RGPL=Ilumina RGPU=machine RGSM=Consensus >null 2>&1
echo "Deduplicating...."
~/Software/jre1.8.0_191/bin/java -jar -XX:ParallelGCThreads=16  ~/Software/picard.jar MarkDuplicates I=rg_added_sorted.bam O=dedupped.bam  CREATE_INDEX=true VALIDATION_STRINGENCY=SILENT M=output.metrics >null 2>&1

~/Software/jre1.8.0_191/bin/java -jar ~/Software/picard.jar CreateSequenceDictionary R=$1 >null 2>&1

samtools faidx $1 
echo "Calling polymorphisms"
~/Software/jre1.8.0_191/bin/java -jar  ~/Software/gatk3.8/GenomeAnalysisTK.jar -T  HaplotypeCaller -R $1 -I dedupped.bam  -o output.vcf -A StrandAlleleCountsBySample >null 2>&1

filterVCF.py output.vcf >null 2>&1
 

bgzip -c output.vcf_filtered.vcf > output.vcf_filtered.vcf.gz 2>null

tabix output.vcf_filtered.vcf.gz >null 2>&1

echo "Creating consensus..."
cat $1 | bcftools consensus output.vcf_filtered.vcf.gz > $1_con.fasta 2>null

